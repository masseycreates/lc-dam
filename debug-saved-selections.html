<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug: Saved Selections Integration</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .card { background: white; padding: 20px; margin: 10px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        .warning { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-success { background: #28a745; color: white; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .number-display { display: inline-block; background: #007bff; color: white; padding: 4px 8px; margin: 2px; border-radius: 4px; font-size: 12px; }
        .powerball-display { display: inline-block; background: #dc3545; color: white; padding: 4px 8px; margin: 2px; border-radius: 4px; font-size: 12px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Saved Selections Integration Debug Tool</h1>
        <p>This tool helps verify that saved selections are properly integrated into the prediction algorithms.</p>

        <div class="card">
            <h2>üìã Test Setup</h2>
            <button onclick="addTestSavedSelections()" class="btn-primary">Add Test Saved Selections</button>
            <button onclick="clearAllData()" class="btn-secondary">Clear All Data</button>
            <button onclick="checkUserData()" class="btn-success">Check Current User Data</button>
        </div>

        <div class="card">
            <h2>üß™ Integration Tests</h2>
            <button onclick="testSavedSelectionsInAnalytics()" class="btn-primary">Test Analytics Integration</button>
            <button onclick="testEnhancedPredictions()" class="btn-primary">Test Enhanced Predictions</button>
            <button onclick="testFullWorkflow()" class="btn-success">Test Full Workflow</button>
        </div>

        <div class="grid">
            <div class="card">
                <h3>üìä Current User Data</h3>
                <div id="user-data-results">Click "Check Current User Data" to see current state</div>
            </div>
            <div class="card">
                <h3>üßÆ Test Results</h3>
                <div id="test-results">Run tests to see results</div>
            </div>
        </div>

        <div class="card">
            <h3>üìà Enhanced Predictions Results</h3>
            <div id="predictions-results">Run enhanced predictions test to see results</div>
        </div>
    </div>

    <script>
        // Generate a consistent user ID for testing
        const testUserId = 'test_user_' + Date.now().toString(36);
        
        // Add test saved selections
        async function addTestSavedSelections() {
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.innerHTML = '‚è≥ Adding test saved selections...';

            const testSelections = [
                {
                    id: 'saved_1',
                    numbers: [7, 14, 21, 35, 42],
                    powerball: 15,
                    strategy: 'Lucky Numbers',
                    confidence: 80,
                    timestamp: new Date().toISOString(),
                    notes: 'My favorite lucky numbers'
                },
                {
                    id: 'saved_2', 
                    numbers: [3, 12, 23, 34, 45],
                    powerball: 8,
                    strategy: 'Pattern Recognition Neural',
                    confidence: 75,
                    timestamp: new Date().toISOString(),
                    notes: 'Based on recent patterns'
                },
                {
                    id: 'saved_3',
                    numbers: [1, 11, 22, 33, 44],
                    powerball: 12,
                    strategy: 'EWMA Frequency Analysis',
                    confidence: 85,
                    timestamp: new Date().toISOString(),
                    notes: 'High frequency numbers'
                }
            ];

            try {
                const response = await fetch('/api/selection-history', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-ID': testUserId
                    },
                    body: JSON.stringify({
                        type: 'save',
                        selection: testSelections[0]
                    })
                });

                if (response.ok) {
                    // Add the other selections
                    for (let i = 1; i < testSelections.length; i++) {
                        await fetch('/api/selection-history', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-User-ID': testUserId
                            },
                            body: JSON.stringify({
                                type: 'save',
                                selection: testSelections[i]
                            })
                        });
                    }

                    resultsDiv.innerHTML = `
                        <div class="success">
                            ‚úÖ Successfully added ${testSelections.length} test saved selections<br>
                            User ID: ${testUserId}<br>
                            Selections include favorite numbers, patterns, and strategies
                        </div>
                    `;
                } else {
                    throw new Error('Failed to save selections');
                }
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }

        // Check current user data
        async function checkUserData() {
            const resultsDiv = document.getElementById('user-data-results');
            resultsDiv.innerHTML = '‚è≥ Loading user data...';

            try {
                const response = await fetch('/api/selection-history', {
                    method: 'GET',
                    headers: {
                        'X-User-ID': testUserId
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    
                    resultsDiv.innerHTML = `
                        <div class="info">
                            <h4>üìä User Data Summary</h4>
                            <strong>User ID:</strong> ${testUserId}<br>
                            <strong>Regular Selections:</strong> ${data.data.selections.length}<br>
                            <strong>Saved Selections:</strong> ${data.data.savedSelections.length}<br>
                            <strong>Total Selections:</strong> ${data.data.analytics.totalSelections}<br>
                            <strong>Favorite Numbers:</strong> ${data.data.analytics.patternInsights.favoriteNumbers.slice(0, 10).join(', ')}<br>
                            <strong>Preferred Strategies:</strong> ${Object.keys(data.data.analytics.preferredStrategies).join(', ')}<br>
                            <strong>Even/Odd Balance:</strong> ${data.data.analytics.patternInsights.evenOddBalance.even}/${data.data.analytics.patternInsights.evenOddBalance.odd}
                        </div>
                        
                        <h4>üíæ Saved Selections Details:</h4>
                        ${data.data.savedSelections.map(sel => `
                            <div style="margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                                <div>
                                    ${sel.numbers.map(n => `<span class="number-display">${n}</span>`).join('')}
                                    <span class="powerball-display">PB: ${sel.powerball}</span>
                                </div>
                                <div style="margin-top: 5px; font-size: 12px; color: #666;">
                                    Strategy: ${sel.strategy} | Confidence: ${sel.confidence}% | Notes: ${sel.notes}
                                </div>
                            </div>
                        `).join('')}
                    `;
                } else {
                    throw new Error('Failed to load user data');
                }
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }

        // Test saved selections in analytics
        async function testSavedSelectionsInAnalytics() {
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.innerHTML = '‚è≥ Testing analytics integration...';

            try {
                const response = await fetch('/api/selection-history', {
                    method: 'GET',
                    headers: {
                        'X-User-ID': testUserId
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    const analytics = data.data.analytics;
                    
                    const tests = [
                        {
                            name: 'Total selections includes saved selections',
                            expected: data.data.selections.length + data.data.savedSelections.length,
                            actual: analytics.totalSelections,
                            pass: analytics.totalSelections === (data.data.selections.length + data.data.savedSelections.length)
                        },
                        {
                            name: 'Favorite numbers derived from saved selections',
                            expected: 'Array with numbers',
                            actual: analytics.patternInsights.favoriteNumbers.length,
                            pass: analytics.patternInsights.favoriteNumbers.length > 0
                        },
                        {
                            name: 'Strategy preferences include saved selection strategies',
                            expected: 'Object with strategies',
                            actual: Object.keys(analytics.preferredStrategies).length,
                            pass: Object.keys(analytics.preferredStrategies).length > 0
                        },
                        {
                            name: 'Even/odd balance calculated from saved selections',
                            expected: 'Balanced numbers',
                            actual: `${analytics.patternInsights.evenOddBalance.even}/${analytics.patternInsights.evenOddBalance.odd}`,
                            pass: analytics.patternInsights.evenOddBalance.even > 0 || analytics.patternInsights.evenOddBalance.odd > 0
                        }
                    ];

                    resultsDiv.innerHTML = `
                        <div class="info">
                            <h4>üß™ Analytics Integration Test Results</h4>
                            ${tests.map(test => `
                                <div style="margin: 5px 0; padding: 5px; background: ${test.pass ? '#d4edda' : '#f8d7da'}; border-radius: 4px;">
                                    ${test.pass ? '‚úÖ' : '‚ùå'} ${test.name}<br>
                                    <small>Expected: ${test.expected} | Actual: ${test.actual}</small>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    throw new Error('Failed to test analytics');
                }
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }

        // Test enhanced predictions with saved selections
        async function testEnhancedPredictions() {
            const resultsDiv = document.getElementById('predictions-results');
            resultsDiv.innerHTML = '‚è≥ Testing enhanced predictions with saved selections...';

            try {
                // First get user analytics
                const userResponse = await fetch('/api/selection-history', {
                    method: 'GET',
                    headers: {
                        'X-User-ID': testUserId
                    }
                });

                if (!userResponse.ok) {
                    throw new Error('Failed to get user data');
                }

                const userData = await userResponse.json();
                
                // Test enhanced predictions
                const predictionsResponse = await fetch('/api/enhanced-predictions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-ID': testUserId
                    },
                    body: JSON.stringify({
                        historicalData: { drawings: [] }, // Minimal historical data for test
                        userAnalytics: userData.data.analytics,
                        requestedSets: 3,
                        enhancementLevel: 'advanced'
                    })
                });

                if (predictionsResponse.ok) {
                    const predictionsData = await predictionsResponse.json();
                    
                    resultsDiv.innerHTML = `
                        <div class="success">
                            <h4>‚úÖ Enhanced Predictions Test Results</h4>
                            <strong>User Enhanced:</strong> ${predictionsData.data.metadata.userEnhanced ? 'Yes' : 'No'}<br>
                            <strong>Saved Selections Used:</strong> ${predictionsData.data.metadata.savedSelectionsUsed}<br>
                            <strong>Enhancement Level:</strong> ${predictionsData.data.metadata.enhancementLevel}<br>
                            <strong>Confidence Factors:</strong> ${predictionsData.data.metadata.confidenceFactors.length}<br>
                            <strong>Predictions Generated:</strong> ${predictionsData.data.predictions.length}
                        </div>
                        
                        <h4>üéØ Generated Predictions:</h4>
                        ${predictionsData.data.predictions.map((pred, i) => `
                            <div style="margin: 10px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #007bff;">
                                <div style="margin-bottom: 10px;">
                                    <strong>${pred.strategy}</strong> - ${pred.confidence}% Confidence
                                    ${pred.userEnhancement ? `<span style="background: #28a745; color: white; padding: 2px 6px; border-radius: 3px; font-size: 11px; margin-left: 10px;">+${Math.round(pred.userEnhancement * 20)}% from saved selections</span>` : ''}
                                </div>
                                <div style="margin-bottom: 10px;">
                                    ${pred.numbers.map(n => `<span class="number-display">${n}</span>`).join('')}
                                    <span class="powerball-display">PB: ${pred.powerball}</span>
                                </div>
                                <div style="font-size: 12px; color: #666;">
                                    ${pred.description}
                                </div>
                                ${pred.confidenceFactors ? `
                                    <div style="margin-top: 8px; font-size: 11px; color: #555;">
                                        <strong>Confidence Breakdown:</strong>
                                        Base: ${pred.confidenceFactors.base}% |
                                        Algorithm: +${pred.confidenceFactors.algorithm}% |
                                        User Pattern: +${pred.confidenceFactors.userPattern}% |
                                        Strategy: +${pred.confidenceFactors.strategy}%
                                    </div>
                                ` : ''}
                            </div>
                        `).join('')}
                    `;
                } else {
                    throw new Error('Failed to generate enhanced predictions');
                }
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }

        // Test full workflow
        async function testFullWorkflow() {
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.innerHTML = '‚è≥ Running full workflow test...';

            try {
                // Step 1: Add saved selections
                await addTestSavedSelections();
                await new Promise(resolve => setTimeout(resolve, 1000)); // Wait a bit
                
                // Step 2: Check analytics
                await testSavedSelectionsInAnalytics();
                await new Promise(resolve => setTimeout(resolve, 1000)); // Wait a bit
                
                // Step 3: Test predictions
                await testEnhancedPredictions();
                
                resultsDiv.innerHTML += `
                    <div class="success">
                        <h4>üéâ Full Workflow Test Complete!</h4>
                        <p>All components of the saved selections integration have been tested.</p>
                        <p>Check the results in the sections above to verify everything is working correctly.</p>
                    </div>
                `;
            } catch (error) {
                resultsDiv.innerHTML += `<div class="error">‚ùå Full workflow error: ${error.message}</div>`;
            }
        }

        // Clear all data
        async function clearAllData() {
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.innerHTML = '‚è≥ Clearing all test data...';

            try {
                const response = await fetch('/api/selection-history', {
                    method: 'DELETE',
                    headers: {
                        'X-User-ID': testUserId
                    }
                });

                if (response.ok) {
                    resultsDiv.innerHTML = '<div class="success">‚úÖ All test data cleared</div>';
                    document.getElementById('user-data-results').innerHTML = 'Data cleared - click "Check Current User Data" to refresh';
                    document.getElementById('predictions-results').innerHTML = 'Data cleared - run tests to see new results';
                } else {
                    throw new Error('Failed to clear data');
                }
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }
    </script>
</body>
</html>