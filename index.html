<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Lottery Intelligence System</title>
    <link rel="stylesheet" href="styles.css">
    
    <!-- React and Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Load utility modules first -->
    <script src="src/utils/constants.js"></script>
    <script src="src/utils/helpers.js"></script>
    <script src="src/utils/LotteryAlgorithms.js"></script>
    
    <!-- Load services -->
    <script src="src/services/apiService.js"></script>
    <script src="src/services/lotteryService.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo } = React;

        // Main Application Component
        const LotteryApp = () => {
            // State management
            const [currentDrawing, setCurrentDrawing] = useState(null);
            const [historicalData, setHistoricalData] = useState(null);
            const [generatedSets, setGeneratedSets] = useState([]);
            const [userSelections, setUserSelections] = useState([]);
            const [selectedNumbers, setSelectedNumbers] = useState([]);
            const [selectedPowerball, setSelectedPowerball] = useState(null);
            const [claudeApiKey, setClaudeApiKey] = useState('');
            const [analysis, setAnalysis] = useState(null);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [activeTab, setActiveTab] = useState('generator');

            // Initialize the application
            useEffect(() => {
                const initializeApp = async () => {
                    setLoading(true);
                    try {
                        // Initialize lottery service
                        const result = await window.lotteryService.initialize();
                        if (result.success) {
                            // Load initial data
                            setCurrentDrawing(window.lotteryService.getCurrentDrawing());
                            setHistoricalData(window.lotteryService.getHistoricalData());
                            setGeneratedSets(window.lotteryService.getGeneratedSets());
                            setUserSelections(window.lotteryService.getUserSelections());
                        }
                        
                        // Load saved API key
                        const savedApiKey = window.loadFromStorage(window.LOTTERY_CONFIG.STORAGE_KEYS.API_KEY);
                        if (savedApiKey) {
                            setClaudeApiKey(savedApiKey);
                        }
                    } catch (err) {
                        setError('Failed to initialize application');
                        console.error('Initialization error:', err);
                    } finally {
                        setLoading(false);
                    }
                };

                initializeApp();
            }, []);

            // Generate numbers using selected algorithm
            const generateNumbers = useCallback(async (algorithm = 'hybrid', count = 5) => {
                console.log(`Generating numbers with algorithm: ${algorithm}, count: ${count}`);
                setLoading(true);
                setError(null);

                try {
                    console.log('Calling lotteryService.generateNumbers...');
                    const result = await window.lotteryService.generateNumbers(algorithm, count);
                    console.log('Generation result:', result);

                    if (result.success) {
                        const newGeneratedSets = window.lotteryService.getGeneratedSets();
                        console.log('New generated sets:', newGeneratedSets);
                        setGeneratedSets(newGeneratedSets);
                    } else {
                        console.error('Generation failed:', result.error);
                        setError(result.error);
                    }
                } catch (err) {
                    console.error('Generation error:', err);
                    setError('Failed to generate numbers');
                } finally {
                    setLoading(false);
                }
            }, []);

            // Save user selection
            const saveSelection = useCallback(() => {
                if (selectedNumbers.length !== 5 || !selectedPowerball) {
                    setError('Please select 5 numbers and 1 Powerball');
                    return;
                }

                const result = window.lotteryService.saveUserSelection(
                    selectedNumbers, 
                    selectedPowerball
                );
                
                if (result.success) {
                    setUserSelections(window.lotteryService.getUserSelections());
                    setSelectedNumbers([]);
                    setSelectedPowerball(null);
                    setError(null);
                } else {
                    setError(result.error);
                }
            }, [selectedNumbers, selectedPowerball]);

            // Analyze numbers
            const analyzeNumbers = useCallback(async (numbers, powerball) => {
                setLoading(true);
                setError(null);
                
                try {
                    const result = await window.lotteryService.analyzeNumbers(numbers, powerball);
                    if (result.success) {
                        setAnalysis(result.data);
                    } else {
                        setError(result.error);
                    }
                } catch (err) {
                    setError('Failed to analyze numbers');
                    console.error('Analysis error:', err);
                } finally {
                    setLoading(false);
                }
            }, []);

            // Get Claude analysis
            const getClaudeAnalysis = useCallback(async (prompt) => {
                if (!claudeApiKey) {
                    setError('Please enter your Claude API key');
                    return;
                }

                setLoading(true);
                setError(null);
                
                try {
                    const result = await window.apiService.getClaudeAnalysis(prompt, claudeApiKey);
                    if (result.success) {
                        return result.data;
                    } else {
                        setError(result.error);
                        return null;
                    }
                } catch (err) {
                    setError('Failed to get Claude analysis');
                    console.error('Claude analysis error:', err);
                    return null;
                } finally {
                    setLoading(false);
                }
            }, [claudeApiKey]);

            // Save API key
            const saveApiKey = useCallback(() => {
                if (claudeApiKey) {
                    window.saveToStorage(window.LOTTERY_CONFIG.STORAGE_KEYS.API_KEY, claudeApiKey);
                }
            }, [claudeApiKey]);

            // Number selection handlers
            const toggleNumber = useCallback((number) => {
                setSelectedNumbers(prev => {
                    if (prev.includes(number)) {
                        return prev.filter(n => n !== number);
                    } else if (prev.length < 5) {
                        return [...prev, number].sort((a, b) => a - b);
                    }
                    return prev;
                });
            }, []);

            const selectPowerball = useCallback((powerball) => {
                setSelectedPowerball(powerball);
            }, []);

            // Quick pick
            const quickPick = useCallback(() => {
                const numbers = window.generateRandomNumbers(1, 69, 5);
                const powerball = Math.floor(Math.random() * 26) + 1;
                setSelectedNumbers(numbers);
                setSelectedPowerball(powerball);
            }, []);

            // Render number grid
            const renderNumberGrid = (min, max, selected, onSelect, className = '') => {
                const numbers = [];
                for (let i = min; i <= max; i++) {
                    numbers.push(
                        <button
                            key={i}
                            className={`number-btn ${selected.includes ? selected.includes(i) ? 'selected' : '' : selected === i ? 'selected' : ''} ${className}`}
                            onClick={() => onSelect(i)}
                        >
                            {i}
                        </button>
                    );
                }
                return numbers;
            };

            // Render generated sets
            const renderGeneratedSets = () => {
                return generatedSets.map((set, index) => (
                    <div key={set.id || index} className="generated-set">
                        <div className="set-header">
                            <span className="algorithm-name">{set.algorithm}</span>
                            <span className="confidence">
                                Confidence: {window.formatPercentage(set.confidence)}
                            </span>
                        </div>
                        <div className="numbers">
                            {set.numbers.map(num => (
                                <span key={num} className="number">{num}</span>
                            ))}
                            <span className="powerball">PB: {set.powerball}</span>
                        </div>
                        <div className="set-description">{set.description}</div>
                        <div className="set-actions">
                            <button onClick={() => analyzeNumbers(set.numbers, set.powerball)}>
                                Analyze
                            </button>
                            <button onClick={() => {
                                setSelectedNumbers(set.numbers);
                                setSelectedPowerball(set.powerball);
                            }}>
                                Use These Numbers
                            </button>
                        </div>
                    </div>
                ));
            };

            // Render user selections
            const renderUserSelections = () => {
                return userSelections.map((selection, index) => (
                    <div key={selection.id || index} className="user-selection">
                        <div className="selection-header">
                            <span className="selection-name">{selection.name}</span>
                            <span className="selection-date">
                                {window.formatDate(new Date(selection.timestamp))}
                            </span>
                        </div>
                        <div className="numbers">
                            {selection.numbers.map(num => (
                                <span key={num} className="number">{num}</span>
                            ))}
                            <span className="powerball">PB: {selection.powerball}</span>
                        </div>
                        <div className="selection-actions">
                            <button onClick={() => analyzeNumbers(selection.numbers, selection.powerball)}>
                                Analyze
                            </button>
                            <button onClick={() => window.lotteryService.deleteUserSelection(selection.id)}>
                                Delete
                            </button>
                        </div>
                    </div>
                ));
            };

            // Render analysis results
            const renderAnalysis = () => {
                if (!analysis) return null;

                return (
                    <div className="analysis-results">
                        <h3>Number Analysis</h3>
                        <div className="analysis-section">
                            <h4>Selected Numbers</h4>
                            <div className="numbers">
                                {analysis.numbers.map(num => (
                                    <span key={num} className="number">{num}</span>
                                ))}
                                <span className="powerball">PB: {analysis.powerball}</span>
                            </div>
                        </div>
                        
                        {analysis.frequency && (
                            <div className="analysis-section">
                                <h4>Frequency Analysis</h4>
                                <div className="frequency-data">
                                    {analysis.frequency.numbers.map(item => (
                                        <div key={item.number} className="freq-item">
                                            <span>Number {item.number}</span>
                                            <span>Frequency: {item.frequency}</span>
                                            <span>Percentile: {window.formatPercentage(item.percentile / 100)}</span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {analysis.patterns && (
                            <div className="analysis-section">
                                <h4>Pattern Analysis</h4>
                                <div className="pattern-data">
                                    <div>Sum: {analysis.patterns.sum}</div>
                                    <div>Range: {analysis.patterns.range}</div>
                                    <div>Even/Odd: {analysis.patterns.evenOdd.ratio}</div>
                                    {analysis.patterns.consecutive.length > 0 && (
                                        <div>Consecutive: {analysis.patterns.consecutive.map(seq => seq.join('-')).join(', ')}</div>
                                    )}
                                </div>
                            </div>
                        )}

                        {analysis.recommendations && analysis.recommendations.length > 0 && (
                            <div className="analysis-section">
                                <h4>Recommendations</h4>
                                <div className="recommendations">
                                    {analysis.recommendations.map((rec, index) => (
                                        <div key={index} className={`recommendation ${rec.type}`}>
                                            {rec.message}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                );
            };

            if (loading && !currentDrawing) {
                return <div className="loading">Loading...</div>;
            }

            return (
                <div className="lottery-app">
                    <header className="app-header">
                        <h1>Advanced Lottery Intelligence System</h1>
                        {currentDrawing && (
                            <div className="current-jackpot">
                                Next Jackpot: {window.formatCurrency(currentDrawing.jackpot || 0)}
                            </div>
                        )}
                    </header>

                    {error && (
                        <div className="error-message">
                            {error}
                            <button onClick={() => setError(null)}>Ã—</button>
                        </div>
                    )}

                    <nav className="tab-navigation">
                        <button 
                            className={activeTab === 'generator' ? 'active' : ''}
                            onClick={() => setActiveTab('generator')}
                        >
                            Number Generator
                        </button>
                        <button 
                            className={activeTab === 'manual' ? 'active' : ''}
                            onClick={() => setActiveTab('manual')}
                        >
                            Manual Selection
                        </button>
                        <button 
                            className={activeTab === 'analysis' ? 'active' : ''}
                            onClick={() => setActiveTab('analysis')}
                        >
                            Analysis
                        </button>
                        <button 
                            className={activeTab === 'history' ? 'active' : ''}
                            onClick={() => setActiveTab('history')}
                        >
                            My Selections
                        </button>
                        <button 
                            className={activeTab === 'settings' ? 'active' : ''}
                            onClick={() => setActiveTab('settings')}
                        >
                            Settings
                        </button>
                    </nav>

                    <main className="app-content">
                        {activeTab === 'generator' && (
                            <div className="generator-tab">
                                <div className="generator-controls">
                                    <h2>AI Number Generator</h2>
                                    <div className="algorithm-buttons">
                                        <button onClick={() => generateNumbers('frequency')}>
                                            Frequency Analysis
                                        </button>
                                        <button onClick={() => generateNumbers('hot_cold')}>
                                            Hot & Cold Numbers
                                        </button>
                                        <button onClick={() => generateNumbers('pattern')}>
                                            Pattern Analysis
                                        </button>
                                        <button onClick={() => generateNumbers('statistical')}>
                                            Statistical
                                        </button>
                                        <button onClick={() => generateNumbers('hybrid')}>
                                            Hybrid (Recommended)
                                        </button>
                                        <button onClick={() => generateNumbers('random')}>
                                            Random
                                        </button>
                                    </div>
                                </div>
                                
                                <div className="generated-sets-container">
                                    <h3>Generated Number Sets</h3>
                                    {generatedSets.length === 0 ? (
                                        <p>No generated sets yet. Click an algorithm button above to generate numbers.</p>
                                    ) : (
                                        <div className="generated-sets">
                                            {renderGeneratedSets()}
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {activeTab === 'manual' && (
                            <div className="manual-tab">
                                <h2>Manual Number Selection</h2>
                                
                                <div className="selection-controls">
                                    <button onClick={quickPick}>Quick Pick</button>
                                    <button onClick={() => setSelectedNumbers([])}>Clear Numbers</button>
                                    <button onClick={() => setSelectedPowerball(null)}>Clear Powerball</button>
                                    <button 
                                        onClick={saveSelection}
                                        disabled={selectedNumbers.length !== 5 || !selectedPowerball}
                                    >
                                        Save Selection
                                    </button>
                                </div>

                                <div className="number-selection">
                                    <div className="selected-display">
                                        <h3>Selected Numbers ({selectedNumbers.length}/5)</h3>
                                        <div className="selected-numbers">
                                            {selectedNumbers.map(num => (
                                                <span key={num} className="selected-number">{num}</span>
                                            ))}
                                        </div>
                                        <h3>Powerball: {selectedPowerball || 'None'}</h3>
                                    </div>

                                    <div className="number-grids">
                                        <div className="main-numbers">
                                            <h3>Select 5 Numbers (1-69)</h3>
                                            <div className="number-grid">
                                                {renderNumberGrid(1, 69, selectedNumbers, toggleNumber)}
                                            </div>
                                        </div>

                                        <div className="powerball-numbers">
                                            <h3>Select Powerball (1-26)</h3>
                                            <div className="number-grid powerball-grid">
                                                {renderNumberGrid(1, 26, [selectedPowerball], selectPowerball, 'powerball')}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'analysis' && (
                            <div className="analysis-tab">
                                <h2>Number Analysis</h2>
                                {renderAnalysis()}
                            </div>
                        )}

                        {activeTab === 'history' && (
                            <div className="history-tab">
                                <h2>My Selections</h2>
                                {userSelections.length === 0 ? (
                                    <p>No saved selections yet.</p>
                                ) : (
                                    <div className="user-selections">
                                        {renderUserSelections()}
                                    </div>
                                )}
                            </div>
                        )}

                        {activeTab === 'settings' && (
                            <div className="settings-tab">
                                <h2>Settings</h2>
                                <div className="setting-group">
                                    <label htmlFor="claude-api-key">Claude API Key:</label>
                                    <input
                                        id="claude-api-key"
                                        type="password"
                                        value={claudeApiKey}
                                        onChange={(e) => setClaudeApiKey(e.target.value)}
                                        onBlur={saveApiKey}
                                        placeholder="Enter your Claude API key"
                                    />
                                    <small>Your API key is stored locally and never sent to our servers.</small>
                                </div>
                            </div>
                        )}
                    </main>

                    {loading && (
                        <div className="loading-overlay">
                            <div className="loading-spinner">Loading...</div>
                        </div>
                    )}
                </div>
            );
        };

        // Render the application
        ReactDOM.render(<LotteryApp />, document.getElementById('root'));
    </script>
</body>
</html>