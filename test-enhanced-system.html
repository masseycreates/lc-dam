<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Lottery System Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üß† Enhanced Lottery System Test</h1>
    
    <div class="test-section info">
        <h2>üìä System Status</h2>
        <div id="system-status">Loading...</div>
    </div>

    <div class="test-section">
        <h2>üîó API Connectivity Tests</h2>
        <button onclick="testSelectionHistoryAPI()">Test Selection History API</button>
        <button onclick="testEnhancedPredictionsAPI()">Test Enhanced Predictions API</button>
        <div id="api-results"></div>
    </div>

    <div class="test-section">
        <h2>üíæ Data Persistence Tests</h2>
        <button onclick="testSaveSelection()">Test Save Selection</button>
        <button onclick="testLoadSelections()">Test Load Selections</button>
        <button onclick="testUserAnalytics()">Test User Analytics</button>
        <div id="persistence-results"></div>
    </div>

    <div class="test-section">
        <h2>üßÆ Enhanced Predictions Tests</h2>
        <button onclick="testPersonalizedPredictions()">Test Personalized Predictions</button>
        <button onclick="testConfidenceScoring()">Test Confidence Scoring</button>
        <div id="predictions-results"></div>
    </div>

    <script>
        let userId = null;
        let testResults = [];

        // Initialize test environment
        async function initializeTests() {
            const statusDiv = document.getElementById('system-status');
            statusDiv.innerHTML = '‚è≥ Initializing test environment...';

            try {
                // Test basic connectivity
                const response = await fetch('/api/selection-history', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    const data = await response.json();
                    userId = data.userId;
                    statusDiv.innerHTML = `
                        ‚úÖ System Online<br>
                        üÜî User ID: ${userId}<br>
                        üìä Selection History API: Connected<br>
                        üß† Enhanced Predictions API: Available<br>
                        üíæ Cross-device Persistence: Enabled
                    `;
                } else {
                    statusDiv.innerHTML = '‚ùå System Offline - APIs not responding';
                }
            } catch (error) {
                statusDiv.innerHTML = `‚ùå System Error: ${error.message}`;
            }
        }

        // Test Selection History API
        async function testSelectionHistoryAPI() {
            const resultsDiv = document.getElementById('api-results');
            resultsDiv.innerHTML = '‚è≥ Testing Selection History API...';

            try {
                // Test GET
                const getResponse = await fetch('/api/selection-history');
                const getData = await getResponse.json();
                
                // Test POST (save a test selection)
                const testSelection = {
                    selection: {
                        name: 'Test Selection',
                        numbers: [1, 2, 3, 4, 5],
                        powerball: 10,
                        strategy: 'Test',
                        confidence: 75,
                        description: 'Test selection for API validation'
                    },
                    saveType: 'history'
                };

                const postResponse = await fetch('/api/selection-history', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-ID': userId
                    },
                    body: JSON.stringify(testSelection)
                });

                const postData = await postResponse.json();

                resultsDiv.innerHTML = `
                    <div class="success">
                        ‚úÖ Selection History API Tests Passed<br>
                        üì• GET: ${getData.success ? 'Success' : 'Failed'}<br>
                        üì§ POST: ${postData.success ? 'Success' : 'Failed'}<br>
                        üìä User Analytics: ${postData.analytics ? 'Generated' : 'Not Available'}
                    </div>
                `;
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">‚ùå API Test Failed: ${error.message}</div>`;
            }
        }

        // Test Enhanced Predictions API
        async function testEnhancedPredictionsAPI() {
            const resultsDiv = document.getElementById('api-results');
            resultsDiv.innerHTML += '<br>‚è≥ Testing Enhanced Predictions API...';

            try {
                const testRequest = {
                    historicalData: {
                        totalDrawings: 100,
                        averageJackpot: 50000000,
                        numberFrequency: {}
                    },
                    userAnalytics: {
                        totalSelections: 10,
                        favoriteNumbers: [7, 14, 21, 28, 35],
                        preferredStrategies: { 'Frequency': 5, 'Pattern': 3 },
                        averageConfidence: 65
                    },
                    requestedSets: 3,
                    enhancementLevel: 'advanced'
                };

                const response = await fetch('/api/enhanced-predictions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-ID': userId
                    },
                    body: JSON.stringify(testRequest)
                });

                const data = await response.json();

                resultsDiv.innerHTML += `
                    <div class="success">
                        ‚úÖ Enhanced Predictions API Tests Passed<br>
                        üß† Predictions Generated: ${data.success ? data.data.predictions.length : 0}<br>
                        üìà Confidence Factors: ${data.success ? data.data.metadata.confidenceFactors.length : 0}<br>
                        üéØ Personalization: ${data.success && data.data.predictions[0].personalizedFactors ? 'Active' : 'Not Available'}
                    </div>
                `;
            } catch (error) {
                resultsDiv.innerHTML += `<div class="error">‚ùå Enhanced Predictions Test Failed: ${error.message}</div>`;
            }
        }

        // Test data persistence
        async function testSaveSelection() {
            const resultsDiv = document.getElementById('persistence-results');
            resultsDiv.innerHTML = '‚è≥ Testing selection persistence...';

            try {
                const testSelection = {
                    selection: {
                        name: 'Persistence Test',
                        numbers: [10, 20, 30, 40, 50],
                        powerball: 15,
                        strategy: 'Test Strategy',
                        confidence: 80,
                        description: 'Testing cross-device persistence'
                    },
                    saveType: 'saved'
                };

                const response = await fetch('/api/selection-history', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-ID': userId
                    },
                    body: JSON.stringify(testSelection)
                });

                const data = await response.json();

                resultsDiv.innerHTML = `
                    <div class="success">
                        ‚úÖ Selection Persistence Test Passed<br>
                        üíæ Saved to Server: ${data.success ? 'Yes' : 'No'}<br>
                        üîÑ Analytics Updated: ${data.analytics ? 'Yes' : 'No'}<br>
                        üì± Cross-device Ready: ${data.success ? 'Yes' : 'No'}
                    </div>
                `;
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">‚ùå Persistence Test Failed: ${error.message}</div>`;
            }
        }

        // Test loading selections
        async function testLoadSelections() {
            const resultsDiv = document.getElementById('persistence-results');
            resultsDiv.innerHTML += '<br>‚è≥ Testing selection loading...';

            try {
                const response = await fetch('/api/selection-history', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-ID': userId
                    }
                });

                const data = await response.json();

                resultsDiv.innerHTML += `
                    <div class="success">
                        ‚úÖ Selection Loading Test Passed<br>
                        üìä History Entries: ${data.data.selections ? data.data.selections.length : 0}<br>
                        üíæ Saved Selections: ${data.data.savedSelections ? data.data.savedSelections.length : 0}<br>
                        üß† Analytics Available: ${data.data.analytics ? 'Yes' : 'No'}
                    </div>
                `;
            } catch (error) {
                resultsDiv.innerHTML += `<div class="error">‚ùå Loading Test Failed: ${error.message}</div>`;
            }
        }

        // Test user analytics
        async function testUserAnalytics() {
            const resultsDiv = document.getElementById('persistence-results');
            resultsDiv.innerHTML += '<br>‚è≥ Testing user analytics...';

            try {
                const response = await fetch('/api/selection-history');
                const data = await response.json();

                if (data.data.analytics) {
                    const analytics = data.data.analytics;
                    resultsDiv.innerHTML += `
                        <div class="success">
                            ‚úÖ User Analytics Test Passed<br>
                            üìà Total Selections: ${analytics.totalSelections}<br>
                            üéØ Favorite Numbers: ${analytics.patternInsights?.favoriteNumbers?.length || 0}<br>
                            üìä Preferred Strategies: ${Object.keys(analytics.preferredStrategies || {}).length}<br>
                            üßÆ Average Confidence: ${analytics.averageConfidence?.toFixed(1) || 0}%
                        </div>
                    `;
                } else {
                    resultsDiv.innerHTML += '<div class="info">‚ÑπÔ∏è No analytics data available yet</div>';
                }
            } catch (error) {
                resultsDiv.innerHTML += `<div class="error">‚ùå Analytics Test Failed: ${error.message}</div>`;
            }
        }

        // Test personalized predictions
        async function testPersonalizedPredictions() {
            const resultsDiv = document.getElementById('predictions-results');
            resultsDiv.innerHTML = '‚è≥ Testing personalized predictions...';

            try {
                // First get user analytics
                const userResponse = await fetch('/api/selection-history');
                const userData = await userResponse.json();

                if (!userData.data.analytics || userData.data.analytics.totalSelections === 0) {
                    resultsDiv.innerHTML = '<div class="info">‚ÑπÔ∏è Need selection history for personalized predictions. Add some selections first.</div>';
                    return;
                }

                const testRequest = {
                    historicalData: { totalDrawings: 100, numberFrequency: {} },
                    userAnalytics: userData.data.analytics,
                    requestedSets: 2,
                    enhancementLevel: 'advanced'
                };

                const response = await fetch('/api/enhanced-predictions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-ID': userId
                    },
                    body: JSON.stringify(testRequest)
                });

                const data = await response.json();

                if (data.success) {
                    const prediction = data.data.predictions[0];
                    resultsDiv.innerHTML = `
                        <div class="success">
                            ‚úÖ Personalized Predictions Test Passed<br>
                            üéØ Generated: ${data.data.predictions.length} predictions<br>
                            üìà Enhanced Confidence: ${prediction.confidence}%<br>
                            üß† User Enhancement: ${prediction.userEnhancement || 0}%<br>
                            üìä Strategy: ${prediction.strategy}<br>
                            üî¢ Numbers: ${prediction.numbers.join(', ')} | ${prediction.powerball}
                        </div>
                    `;
                } else {
                    resultsDiv.innerHTML = `<div class="error">‚ùå Prediction generation failed</div>`;
                }
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">‚ùå Personalized Predictions Test Failed: ${error.message}</div>`;
            }
        }

        // Test confidence scoring
        async function testConfidenceScoring() {
            const resultsDiv = document.getElementById('predictions-results');
            resultsDiv.innerHTML += '<br>‚è≥ Testing confidence scoring...';

            try {
                const testRequest = {
                    historicalData: { totalDrawings: 100, numberFrequency: {} },
                    userAnalytics: {
                        totalSelections: 15,
                        favoriteNumbers: [7, 14, 21, 28, 35],
                        preferredStrategies: { 'Frequency': 8, 'Pattern': 4, 'Gap': 3 },
                        averageConfidence: 72
                    },
                    requestedSets: 1,
                    enhancementLevel: 'advanced'
                };

                const response = await fetch('/api/enhanced-predictions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-ID': userId
                    },
                    body: JSON.stringify(testRequest)
                });

                const data = await response.json();

                if (data.success) {
                    const prediction = data.data.predictions[0];
                    resultsDiv.innerHTML += `
                        <div class="success">
                            ‚úÖ Confidence Scoring Test Passed<br>
                            üìä Base Confidence: ${prediction.baseConfidence || 'N/A'}%<br>
                            üß† User Enhancement: ${prediction.userEnhancement || 0}%<br>
                            üéØ Final Confidence: ${prediction.confidence}%<br>
                            üìà Confidence Factors: ${prediction.confidenceFactors ? prediction.confidenceFactors.length : 0}
                        </div>
                    `;
                } else {
                    resultsDiv.innerHTML += `<div class="error">‚ùå Confidence scoring failed</div>`;
                }
            } catch (error) {
                resultsDiv.innerHTML += `<div class="error">‚ùå Confidence Scoring Test Failed: ${error.message}</div>`;
            }
        }

        // Initialize tests when page loads
        window.addEventListener('load', initializeTests);
    </script>
</body>
</html>